<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Accessories Adda - Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">

  <h2 class="text-center text-danger mb-4">Accessories Adda - Admin Panel</h2>

  <!-- Login -->
  <div id="login-section" class="card p-4 mx-auto" style="max-width:400px;">
    <h4 class="mb-3">Admin Login</h4>
    <input id="username" class="form-control mb-2" placeholder="Username">
    <input id="password" type="password" class="form-control mb-3" placeholder="Password">
    <button class="btn btn-primary w-100" onclick="login()">Login</button>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <!-- Invoice Form -->
    <form id="invoiceForm" class="card p-4 shadow-lg mb-4">
      <h4 class="mb-3">Generate New Invoice</h4>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Invoice No</label>
          <input type="text" class="form-control" id="invoiceNo" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Invoice Date</label>
          <input type="date" class="form-control" id="invoiceDate" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Customer Name</label>
          <input type="text" class="form-control" id="customerName" required>
        </div>
      </div>

      <!-- Bill To / Ship To -->
      <h5 class="mt-3">Bill To / Ship To</h5>
      <div class="row mb-3">
        <div class="col-md-6">
          <h6>Bill To</h6>
          <input type="text" class="form-control mb-2" id="billName" placeholder="Customer Name" required>
          <input type="text" class="form-control mb-2" id="billAddress" placeholder="Address" required>
          <input type="text" class="form-control mb-2" id="billMobile" placeholder="Mobile Number" required>
          <input type="text" class="form-control mb-2" id="billAltMobile" placeholder="Alternate Number">
          <input type="email" class="form-control mb-2" id="billEmail" placeholder="Email">
        </div>
        <div class="col-md-6">
          <h6>Ship To</h6>
          <input type="text" class="form-control mb-2" id="shipName" placeholder="Customer Name" required>
          <input type="text" class="form-control mb-2" id="shipAddress" placeholder="Address" required>
          <input type="text" class="form-control mb-2" id="shipMobile" placeholder="Mobile Number" required>
          <input type="text" class="form-control mb-2" id="shipAltMobile" placeholder="Alternate Number">
          <input type="email" class="form-control mb-2" id="shipEmail" placeholder="Email">
        </div>
      </div>

      <!-- Products -->
      <h5 class="mt-3">Products</h5>
      <table class="table table-bordered" id="productsTable">
        <thead>
          <tr>
            <th>Item</th><th>Qty</th><th>Price</th><th>Amount</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="productsBody">
          <tr>
            <td><input type="text" class="form-control" name="item[]" required></td>
            <td><input type="number" class="form-control" name="qty[]" required></td>
            <td><input type="number" class="form-control" name="price[]" required></td>
            <td><input type="number" class="form-control" name="amount[]" readonly></td>
            <td><button type="button" class="btn btn-danger btn-sm removeRow">X</button></td>
          </tr>
        </tbody>
      </table>
      <button type="button" class="btn btn-success mb-3" id="addRow">+ Add Product</button>

      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Discount (%)</label>
          <input type="number" class="form-control" id="discount" value="0">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Terms & Conditions</label>
        <textarea class="form-control" id="terms" rows="4">
Warranty Products:
1. Standard warranty if mentioned.
2. Returns within 7 days for damaged products only.

Without Warranty Products:
1. No returns or exchanges.
2. Seller not responsible for misuse or third-party damage.
3. Prices may change without notice.
        </textarea>
      </div>

      <button type="button" class="btn btn-primary w-100" onclick="saveInvoice()">Save & Generate PDF</button>
    </form>

    <!-- Saved Invoices -->
    <h4>All Invoices</h4>
    <table class="table table-bordered bg-white">
      <thead>
        <tr><th>#</th><th>Customer</th><th>Total</th><th>Actions</th></tr>
      </thead>
      <tbody id="invoice-list"></tbody>
    </table>
  </div>
</div>

<script>
let token = localStorage.getItem("token");

// Add Product Row
document.getElementById("addRow").addEventListener("click", () => {
  let row = `<tr>
    <td><input type="text" class="form-control" name="item[]" required></td>
    <td><input type="number" class="form-control" name="qty[]" required></td>
    <td><input type="number" class="form-control" name="price[]" required></td>
    <td><input type="number" class="form-control" name="amount[]" readonly></td>
    <td><button type="button" class="btn btn-danger btn-sm removeRow">X</button></td>
  </tr>`;
  document.getElementById("productsBody").insertAdjacentHTML("beforeend", row);
});

// Remove Row
document.addEventListener("click", e => {
  if (e.target.classList.contains("removeRow")) {
    e.target.closest("tr").remove();
  }
});

// Login
async function login() {
  const res = await fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      username: document.getElementById("username").value,
      password: document.getElementById("password").value
    })
  });
  const data = await res.json();
  if (data.token) {
    localStorage.setItem("token", data.token);
    token = data.token;
    showDashboard();
  } else alert("Login failed");
}

async function showDashboard() {
  document.getElementById("login-section").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
  loadInvoices();
  autoInvoiceNo();
}

// Auto Invoice Number
async function autoInvoiceNo() {
  const res = await fetch("/api/invoices", { headers: { "Authorization": "Bearer " + token }});
  const invoices = await res.json();
  let last = invoices.at(-1);
  document.getElementById("invoiceNo").value = last ? last.number + 1 : 1;
}

// Save Invoice
async function saveInvoice() {
  let rows = document.querySelectorAll("#productsBody tr");
  let products = [];
  let total = 0;

  rows.forEach(row => {
    let item = row.querySelector("input[name='item[]']").value;
    let qty = parseFloat(row.querySelector("input[name='qty[]']").value) || 0;
    let price = parseFloat(row.querySelector("input[name='price[]']").value) || 0;
    let amount = qty * price;
    row.querySelector("input[name='amount[]']").value = amount;
    total += amount;
    products.push({ item, qty, price, amount });
  });

  const discount = parseFloat(document.getElementById("discount").value) || 0;
  const discountAmt = (total * discount) / 100;
  const finalAmt = total - discountAmt;

  const invoice = {
    number: parseInt(document.getElementById("invoiceNo").value),
    date: document.getElementById("invoiceDate").value,
    customer: { name: document.getElementById("customerName").value },
    billTo: {
      name: document.getElementById("billName").value,
      address: document.getElementById("billAddress").value,
      mobile: document.getElementById("billMobile").value,
      altMobile: document.getElementById("billAltMobile").value,
      email: document.getElementById("billEmail").value
    },
    shipTo: {
      name: document.getElementById("shipName").value,
      address: document.getElementById("shipAddress").value,
      mobile: document.getElementById("shipMobile").value,
      altMobile: document.getElementById("shipAltMobile").value,
      email: document.getElementById("shipEmail").value
    },
    products, discount, discountAmt, total, finalAmt,
    terms: document.getElementById("terms").value
  };

  await fetch("/api/invoices", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify(invoice)
  });

  generatePDF(invoice);
  loadInvoices();
  autoInvoiceNo();
}

// Load Invoices
async function loadInvoices() {
  const res = await fetch("/api/invoices", { headers: { "Authorization": "Bearer " + token }});
  const invoices = await res.json();
  const tbody = document.getElementById("invoice-list");
  tbody.innerHTML = "";
  invoices.forEach(inv => {
    const row = `<tr>
      <td>${inv.number}</td>
      <td>${inv.customer?.name || ""}</td>
      <td>${inv.finalAmt || 0}</td>
      <td>
        <button class="btn btn-sm btn-info" onclick='generatePDF(${JSON.stringify(inv)})'>PDF</button>
        <button class="btn btn-sm btn-danger" onclick='deleteInvoice("${inv.id}")'>Delete</button>
      </td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

async function deleteInvoice(id) {
  if (!confirm("Delete this invoice?")) return;
  await fetch("/api/invoices/" + id, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });
  loadInvoices();
}

// Generate PDF
function generatePDF(inv) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  doc.setFontSize(16); doc.setTextColor(200,0,0);
  doc.text("Accessories Adda", 14, 15);
  doc.setFontSize(10); doc.setTextColor(0,0,0);
  doc.text("Indore, Madhya Pradesh", 14, 22);
  doc.text("Phone: +91 9770274616", 14, 28);
  doc.setFontSize(14);
  doc.text("Cash Invoice", 150, 15);

  doc.setFontSize(10);
  doc.text(`Invoice No: ${inv.number}`, 150, 22);
  doc.text(`Invoice Date: ${inv.date}`, 150, 28);

  doc.autoTable({
    startY: 35,
    head: [['Bill To', 'Ship To']],
    body: [[
      `Name: ${inv.billTo.name}\nAddress: ${inv.billTo.address}\nMobile: ${inv.billTo.mobile}\nAlt: ${inv.billTo.altMobile}\nEmail: ${inv.billTo.email}`,
      `Name: ${inv.shipTo.name}\nAddress: ${inv.shipTo.address}\nMobile: ${inv.shipTo.mobile}\nAlt: ${inv.shipTo.altMobile}\nEmail: ${inv.shipTo.email}`
    ]],
    theme: 'grid',
    styles: { fontSize: 9 }
  });

  let products = inv.products.map(p => [p.item, p.qty, p.price, p.amount]);
  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 10,
    head: [['Item', 'Qty', 'Price', 'Amount']],
    body: products,
    theme: 'grid',
    styles: { fontSize: 9 }
  });

  doc.autoTable({
    startY: doc.lastAutoTable.finalY + 10,
    margin: { left: 120 },
    body: [
      ["Total Amount", inv.total.toFixed(2)],
      ["Discount", inv.discount + "%"],
      ["Discount Value", inv.discountAmt.toFixed(2)],
      ["Final Payable", inv.finalAmt.toFixed(2)]
    ],
    theme: 'grid',
    styles: { fontSize: 9 }
  });

  doc.setFontSize(11);
  doc.text("Terms & Conditions:", 14, doc.lastAutoTable.finalY + 20);
  doc.setFontSize(9);
  let lines = doc.splitTextToSize(inv.terms, 180);
  doc.text(lines, 14, doc.lastAutoTable.finalY + 28);

  // --- FIXED FOOTER LINE ---
  doc.setFontSize(9);
  doc.setTextColor(100);
  doc.text(
    "This is a computer-generated invoice and does not require a physical signature.",
    14,
    290 // A4 ke bottom margin par
  );

  doc.save(`Invoice_${inv.number}.pdf`);
}

if (token) showDashboard();
</script>
</body>
</html>
